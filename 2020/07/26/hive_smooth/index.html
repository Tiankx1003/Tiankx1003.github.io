<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Hive笛卡尔积实现数据平滑"><meta name="keywords" content="BigData,Hive"><meta name="author" content="Tiankx"><meta name="copyright" content="Tiankx"><title>Hive笛卡尔积实现数据平滑 | Tiankx</title><link rel="shortcut icon" href="/fire.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Tiankx" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#所谓平滑"><span class="toc-text">所谓平滑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、拉链表的展开"><span class="toc-text">一、拉链表的展开</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、平滑生成非交易日数据"><span class="toc-text">二、平滑生成非交易日数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#两种优化思路"><span class="toc-text">两种优化思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-是否跨年区分处理"><span class="toc-text">1.是否跨年区分处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-打散左表，扩容右表"><span class="toc-text">2.打散左表，扩容右表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、对于核心数值为空的填充"><span class="toc-text">三、对于核心数值为空的填充</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写在最后"><span class="toc-text">写在最后</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#最终实现"><span class="toc-text">最终实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#环境信息"><span class="toc-text">环境信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟数据生成脚本"><span class="toc-text">虚拟数据生成脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#鸣谢"><span class="toc-text">鸣谢</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/header.jpg"></div><div class="author-info__name text-center">Tiankx</div><div class="author-info__description text-center">Tiankx的个人博客</div><div class="follow-button"><a href="https://github.com/Tiankx1003" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">21</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com" target="_blank" rel="noopener">Molunerfinn</a><a class="author-info-links__name text-center" href="https://kinomin.github.io" target="_blank" rel="noopener">KinoMin</a><a class="author-info-links__name text-center" href="https://molunerfinn.com/hexo-theme-melody-doc" target="_blank" rel="noopener">HexoMelody</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tiankx</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Hive笛卡尔积实现数据平滑</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-26</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>在分析金融行业的投资数据时，经常会使用到平滑这个操作，下面记录了集中情形的实现与优化</p>
<h2 id="所谓平滑"><a href="#所谓平滑" class="headerlink" title="所谓平滑"></a>所谓平滑</h2><p>数据的平滑具体表现有多种情形，简单列举一下几种：</p>
<ol>
<li>拉链表的数据一般没有连续的时间主键，只使用开始日期和结束日期来描述一个状态值(如评级)的生效日期范围，对拉链表做数据平滑就是把起期和止期展开成连续的时间，对应的状态和拉链表中所在时间区间一致</li>
<li>金融行业的交易数据，只有交易日才会有数据，非交易日无数据，所以时间主键会存在不连续的情况，需要把数据平滑成每一天都有，若无某一天的数据，则使用这个日期之前最近的数据</li>
<li>第三种区别于第二种情形，若一张表种的时间主键连续，即每一天都有数据，但是每条数据中有多个核心数值字段，且这些数值字段在某些日期为空，这些数值字段为空的规律不一致或没有规律，需要把数据平滑成核心数值字段都不为空的，若该字段为空，则取该日期之前最近的一个非空数据</li>
</ol>
<p>以上几种情形，在做平滑时都会不可避免的用到笛卡尔积，下面是具体的案例，实现方式以及优化措施</p>
<ul>
<li>文末提供了生成虚拟数据的<a href="#虚拟数据生成脚本">python脚本</a></li>
<li>更具体的代码见<a href="https://github.com/Tiankx1003/TechSummary.git" target="_blank" rel="noopener">Tiankx1003/TechSummary</a></li>
<li>若是有更优的实现方式，欢迎在评论区或<a href="https://github.com/Tiankx1003/tiankx1003.github.io/issues/8" target="_blank" rel="noopener">issues</a>交流</li>
</ul>
<h2 id="一、拉链表的展开"><a href="#一、拉链表的展开" class="headerlink" title="一、拉链表的展开"></a>一、拉链表的展开</h2><p>第一种情形比较简单，只需要使用拉链表和日历表做笛卡尔积就行<br>生成一张日历表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">num</span> (i <span class="built_in">int</span>);<span class="comment">-- 创建一个表用来储存0-9的数字</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> calendar(date_day <span class="built_in">date</span>); <span class="comment">-- 生成一个存储日期的表，datalist是字段名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">num</span> (i) <span class="keyword">values</span> (<span class="number">0</span>), (<span class="number">1</span>), (<span class="number">2</span>), (<span class="number">3</span>), (<span class="number">4</span>), (<span class="number">5</span>), (<span class="number">6</span>), (<span class="number">7</span>), (<span class="number">8</span>), (<span class="number">9</span>);<span class="comment">-- 生成0-9的数字，方便以后计算时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这里是生成并插入日期数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> calendar <span class="comment">-- 2000年以来10000天日期数据</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">date_add</span>(<span class="string">'2000-01-01'</span>, numlist.id) <span class="keyword">as</span> <span class="string">`date`</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            n1.i + n10.i * <span class="number">10</span> + n100.i * <span class="number">100</span> + n1000.i * <span class="number">1000</span> <span class="keyword">as</span> <span class="keyword">id</span></span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">num</span> n1</span><br><span class="line">        <span class="keyword">cross</span> <span class="keyword">join</span> <span class="keyword">num</span> <span class="keyword">as</span> n10</span><br><span class="line">        <span class="keyword">cross</span> <span class="keyword">join</span> <span class="keyword">num</span> <span class="keyword">as</span> n100</span><br><span class="line">        <span class="keyword">cross</span> <span class="keyword">join</span> <span class="keyword">num</span> <span class="keyword">as</span> n1000</span><br><span class="line">    ) <span class="keyword">as</span> numlist;</span><br></pre></td></tr></table></figure>

<p>然后做一张拉链表, 建表语句如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> rating_info_zip(</span><br><span class="line">    key1        <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'主键1'</span>,</span><br><span class="line">    key2        <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'主键2'</span>,</span><br><span class="line">    start_date  <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'起期'</span>,</span><br><span class="line">    end_date    <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'止期'</span>,</span><br><span class="line">    rating      <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'评级'</span></span><br><span class="line">    ) <span class="keyword">comment</span> <span class="string">'评级信息拉链表'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>我们需要得到一张展开成连续日期的表，建表语句如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> rating_info_unzip(</span><br><span class="line">    the_date    <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'日期'</span>,</span><br><span class="line">    key1        <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'主键1'</span>,</span><br><span class="line">    key2        <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'主键2'</span>,</span><br><span class="line">    rating      <span class="keyword">string</span> comnent <span class="string">'评级'</span></span><br><span class="line">    ) <span class="keyword">comment</span> <span class="string">'评级信息表'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>这种情况实现方式就很简单，只需要和日历表做笛卡尔积，然后取出对应时间区间的数据就好</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> rating_info_unzip</span><br><span class="line"><span class="keyword">select</span>  t2.date_day              <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.rating</span><br><span class="line"><span class="keyword">from</span> rating_info_zip t1</span><br><span class="line"><span class="keyword">cross</span> <span class="keyword">join</span> calendar t2</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>上面这种实现方式简单直接，但是性能较差，如果t1有m条数据，t2有n条数据，那么发散后就是m*n<br>后面我们再说优化思路</p>
<h2 id="二、平滑生成非交易日数据"><a href="#二、平滑生成非交易日数据" class="headerlink" title="二、平滑生成非交易日数据"></a>二、平滑生成非交易日数据</h2><p>先做一张交易表，建表语句如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> trade_info(</span><br><span class="line">    the_date    <span class="keyword">string</span> <span class="string">'交易日期'</span>,</span><br><span class="line">    key1        <span class="keyword">string</span> <span class="string">'主键1'</span>,</span><br><span class="line">    key2        <span class="keyword">string</span> <span class="string">'主键2'</span>,</span><br><span class="line">    value1      <span class="keyword">string</span> <span class="string">'数值1'</span>,</span><br><span class="line">    value2      <span class="keyword">string</span> <span class="string">'数值2'</span></span><br><span class="line">    ) <span class="keyword">comment</span> <span class="string">'交易数据'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>数据特征如下图，交易日有数据，非交易日无数据，平滑即复制出一条数据和最近的一条交易日数据一致</p>
<p><img src="/2020/07/26/hive_smooth/smooth1.png" alt></p>
<p>图中以某一组主键为例<code>key1=&#39;A1029&#39; and key2=&#39;C&#39;</code>，能看出只有工作日有数据，需要平滑成下图的效果</p>
<p><img src="/2020/07/26/hive_smooth/smooth2.png" alt></p>
<ul>
<li><code>smooth_date</code>用于表示平滑取自的日期，如周六和周日都是从周五平滑下来的，那他们的smooth_date都是周五的日期</li>
<li><code>is_smooth</code>用于表示该条数据是否是平滑生成的，1为是，0为否，</li>
<li>对于非平滑数据<code>is_smooth=&#39;1&#39;</code>，smooth_date和the_date一致</li>
</ul>
<p>最后平滑后的目标表建表语句如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> trade_info_smooth(</span><br><span class="line">    the_date    <span class="keyword">string</span> <span class="string">'交易日期'</span>,</span><br><span class="line">    key1        <span class="keyword">string</span> <span class="string">'主键1'</span>,</span><br><span class="line">    key2        <span class="keyword">string</span> <span class="string">'主键2'</span>,</span><br><span class="line">    value1      <span class="keyword">string</span> <span class="string">'数值1'</span>,</span><br><span class="line">    value2      <span class="keyword">string</span> <span class="string">'数值2'</span>,</span><br><span class="line">    smooth_date <span class="keyword">string</span> <span class="string">'平滑取自的日期'</span>,</span><br><span class="line">    is_smooth   <span class="keyword">string</span> <span class="string">'是否平滑, 1是'</span></span><br><span class="line">    ) <span class="keyword">comment</span> <span class="string">'交易数据-平滑后'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>实现逻辑如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 第一步先开窗取出每条数据对应的下一个有数据的日期</span></span><br><span class="line"><span class="comment">-- 这个日期减一就是需要平滑的截止日期</span></span><br><span class="line"><span class="comment">-- 为了方便使用我们落成一张临时表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tmp_trade_info <span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span>   the_date       <span class="keyword">as</span> start_date</span><br><span class="line">        ,key1</span><br><span class="line">        ,key2</span><br><span class="line">        ,value1</span><br><span class="line">        ,value2</span><br><span class="line">        ,<span class="keyword">date_sub</span>(</span><br><span class="line">            <span class="keyword">lead</span>(the_date, <span class="number">1</span>, <span class="keyword">to_date</span>(<span class="keyword">current_timestamp</span>))</span><br><span class="line">                <span class="keyword">over</span>(</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> the_date</span><br><span class="line">                    )</span><br><span class="line">            ,<span class="number">1</span></span><br><span class="line">            )           <span class="keyword">as</span> end_date</span><br><span class="line"><span class="keyword">from</span> trade_info</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 有了start_date和end_end_date，后面就和展开拉链表的方式一致了</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_smooth</span><br><span class="line"><span class="keyword">select</span>   t2.date_day        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.value1</span><br><span class="line">        ,t1.value2</span><br><span class="line">        ,t1.the_date        <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="keyword">case</span> <span class="keyword">when</span> t1.start_date = t1.end_date <span class="keyword">then</span> <span class="string">'0'</span></span><br><span class="line">              <span class="keyword">else</span> <span class="string">'1'</span> <span class="keyword">end</span>  <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> tmp_trade_info t1</span><br><span class="line"><span class="keyword">cross</span> <span class="keyword">join</span> calendar t2</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br></pre></td></tr></table></figure>

<h3 id="两种优化思路"><a href="#两种优化思路" class="headerlink" title="两种优化思路"></a>两种优化思路</h3><p>笛卡尔积时左表的每条数据都要发散成n(右表的条数)倍，性能很差，我们可以采用下面两种方式优化</p>
<h4 id="1-是否跨年区分处理"><a href="#1-是否跨年区分处理" class="headerlink" title="1.是否跨年区分处理"></a>1.是否跨年区分处理</h4><p>对于start_date和end_date在同一年的数据我们没必要发散到整张表，只需要和所在年的365天发散即可<br>非交易日跨年的情况占少数，所以这种优化方式对效率提升了大约n/365倍</p>
<ul>
<li>不需要平滑的数据即<code>start_date = end_date</code>，可以直接取</li>
</ul>
<p>以trade_info_smooth为例，实现方式如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_smooth</span><br><span class="line"><span class="keyword">select</span>  t.start_date        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t.key1</span><br><span class="line">        ,t.key2</span><br><span class="line">        ,t.value1</span><br><span class="line">        ,t.value2</span><br><span class="line">        ,t.start_date       <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="string">'0'</span>                <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> tmp_trade_info t</span><br><span class="line"><span class="keyword">where</span> start_date = end_date                     <span class="comment">-- 不需要平滑</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span>   t2.date_day        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.value1</span><br><span class="line">        ,t1.value2</span><br><span class="line">        ,t1.start_date      <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="string">'1'</span>                <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> t.*, <span class="keyword">year</span>(start_day) y</span><br><span class="line">    <span class="keyword">from</span> tmp_trade_info </span><br><span class="line">    <span class="keyword">where</span> start_date &lt;&gt; end_date                <span class="comment">-- 需要平滑</span></span><br><span class="line">        <span class="keyword">and</span> <span class="keyword">year</span>(start_day) = <span class="keyword">year</span>(end_date)    <span class="comment">-- 非跨年</span></span><br><span class="line">    ) t1</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> date_day, <span class="keyword">year</span>(date_day) <span class="keyword">as</span> y <span class="keyword">from</span> calendar) t2</span><br><span class="line"><span class="keyword">on</span> t1.y = t2.y</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_smooth</span><br><span class="line"><span class="keyword">select</span>   t2.date_day        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.value1</span><br><span class="line">        ,t1.value2</span><br><span class="line">        ,t1.start_date      <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="string">'1'</span>                <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> t.*</span><br><span class="line">    <span class="keyword">from</span> tmp_trade_info </span><br><span class="line">    <span class="keyword">where</span> start_date &lt;&gt; end_date                <span class="comment">-- 需要平滑</span></span><br><span class="line">        <span class="keyword">and</span> <span class="keyword">year</span>(start_day) &lt;&gt; <span class="keyword">year</span>(end_date)   <span class="comment">-- 跨年</span></span><br><span class="line">    ) t1</span><br><span class="line"><span class="keyword">join</span> calendar t2</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br></pre></td></tr></table></figure>

<ul>
<li>当然你也可以区别跨月处理，但是性能不如跨年</li>
</ul>
<h4 id="2-打散左表，扩容右表"><a href="#2-打散左表，扩容右表" class="headerlink" title="2.打散左表，扩容右表"></a>2.打散左表，扩容右表</h4><p>在做笛卡尔积时，同一个key会进到一个reducer种进行处理<br>如果存在数据倾斜，key值会有聚集<br>我们可以把左表的key打散，与扩容后的右表通过虚拟主键关联<br>既可以提升并发度，又可以解决数据倾斜问题<br>以trade_info_smooth为例，实现方式如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> mapred.reduce.tasks=<span class="number">20</span>;         <span class="comment">-- 根据打散和扩容程度设置reducer个数</span></span><br><span class="line"><span class="keyword">set</span> hive.auto.convert.join=<span class="literal">false</span>;   <span class="comment">-- 关闭mapjoin</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_smooth</span><br><span class="line"><span class="keyword">select</span>   t2.date_day        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.value1</span><br><span class="line">        ,t1.value2</span><br><span class="line">        ,t1.the_date        <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="keyword">case</span> <span class="keyword">when</span> t1.start_date = t1.end_date <span class="keyword">then</span> <span class="string">'0'</span></span><br><span class="line">              <span class="keyword">else</span> <span class="string">'1'</span> <span class="keyword">end</span>  <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span>  t.*</span><br><span class="line">            ,pmod(<span class="keyword">hash</span>(<span class="keyword">concat</span>(key1,key2)),<span class="number">20</span>) <span class="keyword">as</span> v_key <span class="comment">-- 用于关联的虚拟主键</span></span><br><span class="line">    <span class="keyword">from</span> tmp_trade_info t</span><br><span class="line">    ) t1</span><br><span class="line"><span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> c.date_day, v.v_key <span class="comment">-- 用于关联的虚拟主键</span></span><br><span class="line">    <span class="keyword">from</span> calendar c</span><br><span class="line">    <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">split</span>(<span class="string">'0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19'</span>,<span class="string">','</span>)) v_key <span class="keyword">as</span> v</span><br><span class="line">    t2</span><br><span class="line"><span class="keyword">on</span> t1.v_key = t2.v_key</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br></pre></td></tr></table></figure>

<ul>
<li>reduer个数，打散倍数，扩容倍数，三者一致</li>
</ul>
<h2 id="三、对于核心数值为空的填充"><a href="#三、对于核心数值为空的填充" class="headerlink" title="三、对于核心数值为空的填充"></a>三、对于核心数值为空的填充</h2><p>我们先造一张扩展的交易表， 建表语句如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> trade_info_ext(</span><br><span class="line">    the_date    <span class="keyword">string</span> <span class="string">'交易日期'</span>,</span><br><span class="line">    key1        <span class="keyword">string</span> <span class="string">'主键1'</span>,</span><br><span class="line">    key2        <span class="keyword">string</span> <span class="string">'主键2'</span>,</span><br><span class="line">    value1      <span class="keyword">string</span> <span class="string">'数值1'</span>,</span><br><span class="line">    value2      <span class="keyword">string</span> <span class="string">'数值2'</span>,</span><br><span class="line">    value3      <span class="keyword">string</span> <span class="string">'数值3'</span>,</span><br><span class="line">    value4      <span class="keyword">string</span> <span class="string">'数值4'</span>,</span><br><span class="line">    value5      <span class="keyword">string</span> <span class="string">'数值5'</span></span><br><span class="line">    ) <span class="keyword">comment</span> <span class="string">'交易数据'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>数据特征如下下图，</p>
<p><img src="/2020/07/26/hive_smooth/smooth3.png" alt></p>
<p>图中以某一组主键为例<code>key1=&#39;A1029&#39; and key2=&#39;C&#39;</code>，有更多的数值字段，从图中能看出日期主键连续，但是每个数值字段都有为空的情况，需要给为空的的值填充一个该日期之前最近的一个非空值，最终效果如下图</p>
<p><img src="/2020/07/26/hive_smooth/smooth4.png" alt></p>
<p>表中这些数值字段为空的日期并不存在一致的规律，或者根本就没有规律<br>所以同一天的两个空值字段可能取自不同的日期</p>
<ul>
<li>暂且不关心每个空值转换取自的日期<code>smooth_date</code>和<code>is_smooth</code></li>
</ul>
<p>Oracle数据库支持<code>lag(col ignore nulls)</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_ext_smooth</span><br><span class="line"><span class="keyword">select</span>   the_date</span><br><span class="line">        ,key1</span><br><span class="line">        ,key2</span><br><span class="line">        ,nvl(</span><br><span class="line">            value1,</span><br><span class="line">            lag(value1 <span class="keyword">ignore</span> <span class="keyword">nulls</span>) <span class="comment">-- hive不支持该写法</span></span><br><span class="line">                <span class="keyword">over</span>(</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> the_date</span><br><span class="line">                    )</span><br><span class="line">            ) <span class="keyword">as</span> value1</span><br><span class="line">        <span class="comment">-- value2, value3, value4, value5 ... 同理</span></span><br><span class="line"><span class="keyword">from</span> trade_info_ext</span><br></pre></td></tr></table></figure>

<p>而hive并没有改语法的支持如果针对每个数值字段参考trade_info_smooth的方式处理，然后再通过主键关联在一起<br>代码如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 很长，很蠢，</span></span><br></pre></td></tr></table></figure>
<p>这种实现方式代码逻辑很臃肿，而且效率非常低，时间复杂度提升了n(需要平滑的value字段个数)倍</p>
<p>其实我们可以借助<code>collect_list</code>或者<code>collent_set</code>的自动去重特性来<strong>间接实现</strong><code>ignore nulls</code><br>实现方式如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span>  the_date</span><br><span class="line">        ,key1</span><br><span class="line">        ,key2</span><br><span class="line">        ,ls_value1[<span class="number">0</span>] <span class="keyword">as</span> value1</span><br><span class="line">        <span class="comment">-- value2, value3, value4, value5 ... 同理</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span>   the_date</span><br><span class="line">            ,key1</span><br><span class="line">            ,key2</span><br><span class="line">            ,collect_list(value1)</span><br><span class="line">                <span class="keyword">over</span>(</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> the_date <span class="keyword">desc</span></span><br><span class="line">                    <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span></span><br><span class="line">                    )                       <span class="keyword">as</span> ls_value1</span><br><span class="line">            <span class="comment">-- value2, value3, value4, value5 ... 同理</span></span><br><span class="line">    <span class="keyword">from</span> tab_demo</span><br><span class="line">    ) t</span><br></pre></td></tr></table></figure>

<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>其实上面这些情形是在同一个需求中遇到的，<br>即trade_info_ext表同时存在非交易日无数据和有数据但数值字段为空的情形<br>需要先针对数值字段补充空值，然后在针对日期做平滑处理<br>最初的处理方式是在Sqoop接数据时就完成第一步的逻辑<br>因为是从上游Oracle数据库接入数据，所以可以使用<code>lag(col ignore nulls)</code><br>接入数据后在关联日历表做日期平滑<br>但是数据量过大时容易<strong>拖垮上游数据库性能</strong>，使用Hive分布式处理更合适<br>所以才有了上述的优化</p>
<ul>
<li>区分跨年处理</li>
<li>打散左表扩容右表增加并发度</li>
<li>hive实现<code>ignore nulls</code></li>
</ul>
<h3 id="最终实现"><a href="#最终实现" class="headerlink" title="最终实现"></a>最终实现</h3><h4 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h4><p><img src="/2020/07/26/hive_smooth/env.png" alt></p>
<ul>
<li>CentOS 7.5</li>
<li>hadoop-3.1.3</li>
<li>hive-3.1.2 <em>execution-engine spark-2.4.5</em></li>
<li>python-3.6.8</li>
<li>jdk1.8.0_144</li>
<li>scala-2.11.8</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tmp_trade_info_ext_smooth</span><br><span class="line"><span class="keyword">select</span>  the_date <span class="keyword">as</span> start_date</span><br><span class="line">        ,key1</span><br><span class="line">        ,key2</span><br><span class="line">        ,collect_list(value1)</span><br><span class="line">            <span class="keyword">over</span>(</span><br><span class="line">                <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> the_date <span class="keyword">desc</span></span><br><span class="line">                <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span></span><br><span class="line">                ) <span class="keyword">as</span> value1</span><br><span class="line">        ,collect_list(value2)</span><br><span class="line">            <span class="keyword">over</span>(</span><br><span class="line">                <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> the_date <span class="keyword">desc</span></span><br><span class="line">                <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span></span><br><span class="line">                ) <span class="keyword">as</span> value2</span><br><span class="line">        ,collect_list(value3)</span><br><span class="line">            <span class="keyword">over</span>(</span><br><span class="line">                <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> the_date <span class="keyword">desc</span></span><br><span class="line">                <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span></span><br><span class="line">                ) <span class="keyword">as</span> value3</span><br><span class="line">        ,collect_list(value4)</span><br><span class="line">            <span class="keyword">over</span>(</span><br><span class="line">                <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> the_date <span class="keyword">desc</span></span><br><span class="line">                <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span></span><br><span class="line">                ) <span class="keyword">as</span> value4</span><br><span class="line">        ,collect_list(value5)</span><br><span class="line">            <span class="keyword">over</span>(</span><br><span class="line">                <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> the_date <span class="keyword">desc</span></span><br><span class="line">                <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span></span><br><span class="line">                ) <span class="keyword">as</span> value5</span><br><span class="line">        ,<span class="keyword">lead</span>(the_date, <span class="number">1</span>, <span class="keyword">to_date</span>(<span class="keyword">current_timestamp</span>))</span><br><span class="line">            <span class="keyword">over</span>(</span><br><span class="line">                <span class="keyword">partition</span> <span class="keyword">by</span> key1, key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> the_date</span><br><span class="line">                ) <span class="keyword">as</span> end_date</span><br><span class="line"><span class="keyword">from</span> trade_info_ext</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> mapred.reduce.tasks=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">set</span> hive.auto.convert.join=<span class="literal">false</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_ext_smooth</span><br><span class="line"><span class="keyword">select</span>  t.start_date        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t.key1</span><br><span class="line">        ,t.key2</span><br><span class="line">        ,t1.value1[<span class="number">0</span>]       <span class="keyword">as</span> value1</span><br><span class="line">        ,t1.value2[<span class="number">0</span>]       <span class="keyword">as</span> value2</span><br><span class="line">        ,t1.value3[<span class="number">0</span>]       <span class="keyword">as</span> value3</span><br><span class="line">        ,t1.value4[<span class="number">0</span>]       <span class="keyword">as</span> value4</span><br><span class="line">        ,t1.value5[<span class="number">0</span>]       <span class="keyword">as</span> value5</span><br><span class="line">        ,t.start_date       <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="string">'0'</span>                <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> tmp_trade_info_ext_smooth t</span><br><span class="line"><span class="keyword">where</span> start_date = end_date                     <span class="comment">-- 不需要平滑</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span>   t2.date_day        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.value1[<span class="number">0</span>]       <span class="keyword">as</span> value1</span><br><span class="line">        ,t1.value2[<span class="number">0</span>]       <span class="keyword">as</span> value2</span><br><span class="line">        ,t1.value3[<span class="number">0</span>]       <span class="keyword">as</span> value3</span><br><span class="line">        ,t1.value4[<span class="number">0</span>]       <span class="keyword">as</span> value4</span><br><span class="line">        ,t1.value5[<span class="number">0</span>]       <span class="keyword">as</span> value5</span><br><span class="line">        ,t1.start_date      <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="string">'1'</span>                <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> t.*, <span class="keyword">year</span>(start_day) y, pmod(<span class="keyword">hash</span>(<span class="keyword">concat</span>(key1, key2)), <span class="number">10</span>) v_key</span><br><span class="line">    <span class="keyword">from</span> tmp_trade_info_ext_smooth </span><br><span class="line">    <span class="keyword">where</span> start_date &lt;&gt; end_date                <span class="comment">-- 需要平滑</span></span><br><span class="line">        <span class="keyword">and</span> <span class="keyword">year</span>(start_day) = <span class="keyword">year</span>(end_date)    <span class="comment">-- 非跨年</span></span><br><span class="line">    ) t1</span><br><span class="line"><span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span>   date_day</span><br><span class="line">            ,<span class="keyword">year</span>(date_day) <span class="keyword">as</span> y </span><br><span class="line">            ,v.v_key</span><br><span class="line">    <span class="keyword">from</span> calendar</span><br><span class="line">    <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">split</span>(<span class="string">'0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19'</span>,<span class="string">','</span>)) v_key <span class="keyword">as</span> v</span><br><span class="line">    ) t2</span><br><span class="line"><span class="keyword">on</span> t1.y = t2.y <span class="keyword">and</span> t1.v_key = t2.v_key</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> trade_info_smooth</span><br><span class="line"><span class="keyword">select</span>   t2.date_day        <span class="keyword">as</span> the_date</span><br><span class="line">        ,t1.key1</span><br><span class="line">        ,t1.key2</span><br><span class="line">        ,t1.value1[<span class="number">0</span>]       <span class="keyword">as</span> value1</span><br><span class="line">        ,t1.value2[<span class="number">0</span>]       <span class="keyword">as</span> value2</span><br><span class="line">        ,t1.value3[<span class="number">0</span>]       <span class="keyword">as</span> value3</span><br><span class="line">        ,t1.value4[<span class="number">0</span>]       <span class="keyword">as</span> value4</span><br><span class="line">        ,t1.value5[<span class="number">0</span>]       <span class="keyword">as</span> value5</span><br><span class="line">        ,t1.start_date      <span class="keyword">as</span> smooth_date</span><br><span class="line">        ,<span class="string">'1'</span>                <span class="keyword">as</span> is_smooth</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> t.*, pmod(<span class="keyword">hash</span>(<span class="keyword">concat</span>(key1, key2)), <span class="number">10</span>) v_key</span><br><span class="line">    <span class="keyword">from</span> tmp_trade_info_ext_smooth </span><br><span class="line">    <span class="keyword">where</span> start_date &lt;&gt; end_date                <span class="comment">-- 需要平滑</span></span><br><span class="line">        <span class="keyword">and</span> <span class="keyword">year</span>(start_day) &lt;&gt; <span class="keyword">year</span>(end_date)   <span class="comment">-- 跨年</span></span><br><span class="line">    ) t1</span><br><span class="line"><span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span>   date_day</span><br><span class="line">            ,v.v_key</span><br><span class="line">    <span class="keyword">from</span> calendar</span><br><span class="line">    <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">split</span>(<span class="string">'0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19'</span>,<span class="string">','</span>)) v_key <span class="keyword">as</span> v</span><br><span class="line">    ) t2</span><br><span class="line"><span class="keyword">on</span> t1.v_key = t2.v_key</span><br><span class="line"><span class="keyword">where</span> t2.date_day <span class="keyword">between</span> t1.start_date <span class="keyword">and</span> t1.end_date</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<h3 id="虚拟数据生成脚本"><a href="#虚拟数据生成脚本" class="headerlink" title="虚拟数据生成脚本"></a>虚拟数据生成脚本</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> chinese_calendar <span class="keyword">import</span> is_workday</span><br><span class="line"></span><br><span class="line"><span class="comment"># python -m pip install -i https://pypi.tuna.tsinghua.edu.cn/simple chinesecalendar</span></span><br><span class="line">file_name = <span class="string">'./virtul_data.txt'</span></span><br><span class="line">file_obj = open(file_name, <span class="string">'w'</span>)</span><br><span class="line">file_obj.truncate()</span><br><span class="line">key1_list = [str]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">60</span>):</span><br><span class="line">    key1_str = (<span class="string">'A'</span> + (<span class="string">'%d'</span> % i).zfill(<span class="number">4</span>))</span><br><span class="line">    key1_list.append(key1_str)</span><br><span class="line">init_date = datetime.date(<span class="number">2004</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">2500</span>):</span><br><span class="line">    delta = datetime.timedelta(days=i)</span><br><span class="line">    new_date = init_date + delta</span><br><span class="line">    <span class="keyword">if</span> is_workday(new_date):  <span class="comment"># 只能支持2004到2020年</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">51</span>):</span><br><span class="line">            <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">6</span>) % <span class="number">6</span> != <span class="number">1</span>:</span><br><span class="line">                key1 = key1_list[j]</span><br><span class="line">                rand_num = random.randint(<span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">9</span>) != <span class="number">0</span>:</span><br><span class="line">                    value1 = str(round(random.uniform(<span class="number">999</span>, <span class="number">9999</span>), <span class="number">4</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    value1 = <span class="string">'null'</span></span><br><span class="line">                <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">9</span>) != <span class="number">0</span>:</span><br><span class="line">                    value2 = str(round(random.uniform(<span class="number">99</span>, <span class="number">9999</span>), <span class="number">4</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    value2 = <span class="string">'null'</span></span><br><span class="line">                <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">9</span>) != <span class="number">0</span>:</span><br><span class="line">                    value3 = str(round(random.uniform(<span class="number">9</span>, <span class="number">9999</span>), <span class="number">4</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    value3 = <span class="string">'null'</span></span><br><span class="line">                <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">9</span>) != <span class="number">0</span>:</span><br><span class="line">                    value4 = str(round(random.uniform(<span class="number">999</span>, <span class="number">9999</span>), <span class="number">4</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    value4 = <span class="string">'null'</span></span><br><span class="line">                <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">9</span>) != <span class="number">0</span>:</span><br><span class="line">                    value5 = str(round(random.uniform(<span class="number">0</span>, <span class="number">9999</span>), <span class="number">4</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    value5 = <span class="string">'null'</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> rand_num == <span class="number">0</span>:</span><br><span class="line">                    line = new_date.strftime(<span class="string">'%Y-%m-%d'</span>) + <span class="string">'\t'</span> + str(key1) + <span class="string">'\t'</span> + <span class="string">'C'</span> \</span><br><span class="line">                           + <span class="string">'\t'</span> + value1 + <span class="string">'\t'</span> + value2 + <span class="string">'\t'</span> + value3 + <span class="string">'\t'</span> + value4 + <span class="string">'\t'</span> + value5</span><br><span class="line">                <span class="keyword">elif</span> rand_num == <span class="number">1</span>:</span><br><span class="line">                    line = new_date.strftime(<span class="string">'%Y-%m-%d'</span>) + <span class="string">'\t'</span> + str(key1) + <span class="string">'\t'</span> + <span class="string">'A'</span> \</span><br><span class="line">                           + <span class="string">'\t'</span> + value1 + <span class="string">'\t'</span> + value2 + <span class="string">'\t'</span> + value3 + <span class="string">'\t'</span> + value4 + <span class="string">'\t'</span> + value5</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    line = new_date.strftime(<span class="string">'%Y-%m-%d'</span>) + <span class="string">'\t'</span> + str(key1) + <span class="string">'\t'</span> + <span class="string">'C'</span> \</span><br><span class="line">                           + <span class="string">'\t'</span> + value1 + <span class="string">'\t'</span> + value2 + <span class="string">'\t'</span> + value3 + <span class="string">'\t'</span> + value4 + <span class="string">'\t'</span> + value5</span><br><span class="line">                    line = line + <span class="string">'\n'</span> + new_date.strftime(<span class="string">'%Y-%m-%d'</span>) + <span class="string">'\t'</span> + str(key1) + <span class="string">'\t'</span> + <span class="string">'A'</span> \</span><br><span class="line">                           + <span class="string">'\t'</span> + value1 + <span class="string">'\t'</span> + value2 + <span class="string">'\t'</span> + value3 + <span class="string">'\t'</span> + value4 + <span class="string">'\t'</span> + value5</span><br><span class="line">                print(line + <span class="string">'\n'</span>)</span><br><span class="line">                file_obj.write(line + <span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h4 id="鸣谢"><a href="#鸣谢" class="headerlink" title="鸣谢"></a>鸣谢</h4><ul>
<li><em>感谢<a href="https://github.com/chenshuli001" target="_blank" rel="noopener">书犁</a>长久以来对我工作的帮助与支持</em></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Tiankx</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://tiankx1003.github.io/2020/07/26/hive_smooth/">http://tiankx1003.github.io/2020/07/26/hive_smooth/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/BigData/">BigData</a><a class="post-meta__tags" href="/tags/Hive/">Hive</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/aliPay.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/WeChatPay.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/06/25/Record4Gitalk/"><span>Record4Gitalk</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '92790026f331d18e4b34',
  clientSecret: '178a65c6e00605cff8e87083ee818aa41cfdf013',
  repo: 'tiankx1003.github.io',
  owner: 'tiankx1003',
  admin: 'tiankx1003',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2012 - 2020 By Tiankx</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://github.com/Tianxk1003" target="_blank" rel="noopener">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>